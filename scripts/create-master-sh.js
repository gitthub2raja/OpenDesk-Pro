/**
 * Create MASTER.sh file with proper escaping
 */

import fs from 'fs'

// Build the script content using string concatenation to avoid template literal evaluation
const parts = [
  '#!/bin/bash\n',
  '###############################################################################\n',
  '# OpenDesk Pro - Docker-Only Launcher\n',
  '# This script requires Docker and Docker Compose\n',
  '###############################################################################\n',
  '\n',
  'set -e\n',
  '\n',
  "RED='\\033[0;31m'\n",
  "GREEN='\\033[0;32m'\n",
  "YELLOW='\\033[1;33m'\n",
  "BLUE='\\033[0;34m'\n",
  "NC='\\033[0m'\n",
  '\n',
  'SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"\n',
  'BUNDLE_FILE="$SCRIPT_DIR/MASTER.sh.enc"\n',
  'COMPOSE_FILE="$SCRIPT_DIR/.docker-compose.yml"\n',
  'NGINX_FILE="$SCRIPT_DIR/.nginx-ssl.conf"\n',
  '\n',
  '# Trap to ensure cleanup on exit\n',
  'cleanup() {\n',
  '    rm -f "$COMPOSE_FILE" "$NGINX_FILE"\n',
  '}\n',
  'trap cleanup EXIT INT TERM\n',
  '\n',
  '# Check Docker\n',
  'if ! command -v docker &> /dev/null; then\n',
  '    echo -e "${RED}❌ Error: Docker is not installed.${NC}"\n',
  '    echo "Please install Docker from https://docs.docker.com/get-docker/"\n',
  '    exit 1\n',
  'fi\n',
  '\n',
  '# Check Docker Compose\n',
  'COMPOSE_CMD=""\n',
  'if command -v docker-compose &> /dev/null; then\n',
  '    COMPOSE_CMD="docker-compose"\n',
  'elif docker compose version &> /dev/null 2>&1; then\n',
  '    COMPOSE_CMD="docker compose"\n',
  'else\n',
  '    echo -e "${RED}❌ Error: Docker Compose is not installed.${NC}"\n',
  '    echo "Please install Docker Compose from https://docs.docker.com/compose/install/"\n',
  '    exit 1\n',
  'fi\n',
  '\n',
  '# Decrypt configuration files\n',
  'echo -e "${BLUE}[INFO]${NC} Decrypting configuration..."\n',
  'if ! command -v node &> /dev/null; then\n',
  '    echo -e "${RED}❌ Error: Node.js is required to decrypt configuration${NC}"\n',
  '    echo "Please install Node.js from https://nodejs.org/"\n',
  '    exit 1\n',
  'fi\n',
  '\n',
  'node -e "\n',
  'const fs = require(\\\'fs\\\');\n',
  'const zlib = require(\\\'zlib\\\');\n',
  'const path = require(\\\'path\\\');\n',
  '\n',
  'try {\n',
  '    const content = fs.readFileSync(process.argv[1], \\\'utf8\\\');\n',
  '    const lines = content.split(\\\'\\\\n\\\').filter(l => !l.trim().startsWith(\\\'#\\\'));\n',
  '    const encoded = lines.join(\\\'\\\\n\\\').trim();\n',
  '    const compressed = Buffer.from(encoded, \\\'base64\\\');\n',
  '    const decompressed = zlib.gunzipSync(compressed);\n',
  '    const bundle = JSON.parse(decompressed.toString(\\\'utf8\\\'));\n',
  '    \n',
  '    // Write docker-compose.yml\n',
  '    if (bundle.files[\\\'docker-compose.yml\\\']) {\n',
  '        fs.writeFileSync(process.argv[2], bundle.files[\\\'docker-compose.yml\\\']);\n',
  '    }\n',
  '    \n',
  '    // Write nginx config\n',
  '    if (bundle.files[\\\'nginx-ssl.conf\\\']) {\n',
  '        fs.writeFileSync(process.argv[3], bundle.files[\\\'nginx-ssl.conf\\\']);\n',
  '    }\n',
  '    \n',
  '    process.exit(0);\n',
  '} catch (error) {\n',
  '    console.error(\\\'Decryption error:\\\', error.message);\n',
  '    process.exit(1);\n',
  '}\n',
  '" "$BUNDLE_FILE" "$COMPOSE_FILE" "$NGINX_FILE" || {\n',
  '    echo -e "${RED}❌ Error: Failed to decrypt configuration${NC}"\n',
  '    exit 1\n',
  '}\n',
  '\n',
  '# Verify files were created\n',
  'if [ ! -f "$COMPOSE_FILE" ]; then\n',
  '    echo -e "${RED}❌ Error: Failed to create docker-compose.yml${NC}"\n',
  '    exit 1\n',
  'fi\n',
  '\n',
  '# Run docker compose\n',
  'echo -e "${GREEN}[INFO]${NC} Starting Docker containers..."\n',
  'cd "$SCRIPT_DIR"\n',
  '$COMPOSE_CMD -f "$COMPOSE_FILE" up -d\n',
  '\n',
  '# Clean up immediately (trap will also handle this)\n',
  'cleanup\n',
  '\n',
  'echo -e "${GREEN}✅ OpenDesk Pro is starting...${NC}"\n',
  'echo -e "${YELLOW}Access the application at: http://localhost${NC}"\n',
  'echo -e "${YELLOW}View logs: $COMPOSE_CMD -f .docker-compose.yml logs -f${NC}"\n',
  'echo -e "${YELLOW}Stop: $COMPOSE_CMD -f .docker-compose.yml down${NC}"\n'
]

const masterShContent = parts.join('')

const outputPath = process.argv[2] || 'MASTER.sh'
fs.writeFileSync(outputPath, masterShContent, 'utf8')
fs.chmodSync(outputPath, 0o755)
console.log(`✓ Created: ${outputPath}`)
